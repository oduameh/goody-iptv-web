<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Goody IPTV</title>
<link rel="icon" href="data:,">
<style>
  :root { --bg:#0b0f17; --panel:#121a26; --text:#e9f0ff; --muted:#a7b1c7; --acc:#6aa7ff; }
  html,body { height:100%; margin:0; background:linear-gradient(180deg,#0b0f17,#0a1322); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif; }
  .wrap { max-width:1100px; margin:0 auto; padding:14px; }
  header { display:flex; gap:10px; align-items:center; padding:8px 0 12px; }
  h1 { font-size:20px; margin:0; letter-spacing:.2px; }
  .note { color:var(--muted); font-size:12px; }
  .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
  @media(min-width:900px){ .grid{ grid-template-columns: 360px 1fr; } }
  .panel { background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; }
  input[type="search"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--text); outline:none; }
  ul{ list-style:none; padding:0; margin:8px 0 0; max-height:60vh; overflow:auto; }
  li{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; cursor:pointer; border:1px solid transparent; }
  li:hover{ background:rgba(255,255,255,.06); }
  li.active{ background:rgba(106,167,255,.1); border-color:rgba(106,167,255,.4); }
  .logo{ width:42px; height:42px; object-fit:contain; background:rgba(255,255,255,.06); border-radius:8px; }
  .name{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sub{ color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  video { width:100%; aspect-ratio:16/9; background:#000; border-radius:16px; }
  .topbar{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .btn{ background:var(--acc); color:#001029; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .pill{ font-size:12px; padding:4px 8px; border:1px solid rgba(255,255,255,.2); border-radius:999px; color:var(--muted); }
  footer{ text-align:center; color:var(--muted); font-size:12px; padding:16px 0; }
  
  /* Paywall Modal */
  .paywall-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000; }
  .paywall-modal { background:var(--panel); border:2px solid var(--acc); border-radius:16px; padding:24px; max-width:400px; text-align:center; }
  .paywall-modal h2 { color:var(--acc); margin:0 0 16px; }
  .paywall-modal p { margin:8px 0; }
  .unlock-input { width:100%; padding:12px; margin:16px 0; border-radius:8px; border:1px solid var(--acc); background:rgba(255,255,255,.1); color:var(--text); text-align:center; font-size:16px; }
  .unlock-btn { background:var(--acc); color:#001029; border:none; padding:12px 24px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px; }
  .purchase-btn { background:#28a745; color:#fff; border:none; padding:12px 20px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:16px; }
  .purchase-btn:hover { background:#218838; }
  .trial-info { background:rgba(255,255,255,.05); padding:8px; border-radius:8px; margin:8px 0; font-size:12px; }
  
  /* Premium Features */
  .view-btn { background:rgba(255,255,255,.1); color:var(--text); border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; margin:0 2px; }
  .view-btn.active { background:var(--acc); color:#001029; }
  .view-btn:hover { background:rgba(255,255,255,.2); }
  
  .grid-container { display:grid; gap:8px; max-height:400px; overflow-y:auto; }
  .grid-container.grid-mode { grid-template-columns:repeat(2, 1fr); }
  .grid-container.compact-mode { grid-template-columns:repeat(4, 1fr); }
  
  .channel-card { background:rgba(255,255,255,.06); border-radius:8px; padding:8px; cursor:pointer; border:1px solid transparent; transition:all 0.2s; }
  .channel-card:hover { border-color:var(--acc); background:rgba(106,167,255,.1); }
  .channel-card.compact { padding:4px; text-align:center; }
  .channel-card .channel-name { color:var(--text); font-size:13px; font-weight:600; margin-bottom:2px; overflow:hidden; text-overflow:ellipsis; }
  .channel-card .channel-group { color:var(--muted); font-size:11px; overflow:hidden; text-overflow:ellipsis; }
  .channel-card.compact .channel-name { font-size:10px; margin-bottom:0; }
  .channel-card.compact .channel-group { display:none; }
  
  .recent-list { display:flex; flex-direction:column; gap:4px; max-height:120px; overflow-y:auto; }
  .recent-item { background:rgba(255,255,255,.06); border-radius:6px; padding:6px 8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all 0.2s; }
  .recent-item:hover { background:rgba(106,167,255,.1); }
  .recent-item .recent-name { color:var(--text); font-size:12px; font-weight:600; overflow:hidden; text-overflow:ellipsis; }
  .recent-item .recent-time { color:var(--muted); font-size:10px; white-space:nowrap; }
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0f17">
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Goody IPTV</h1>
      <span class="pill" id="statusPill">Trial: <span id="trialTimer">10:00</span></span>
      <div style="margin-left:auto" class="note">Use only legal streams.</div>
    </header>

    <div class="grid">
      <aside class="panel">
        <div class="note" style="margin-bottom:6px;">Playlist</div>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="playlistUrl" type="search" placeholder="Playlist M3U URL" value="https://iptv-org.github.io/iptv/countries/ie.m3u">
          <button class="btn" id="loadBtn">Load</button>
        </div>
        
        <!-- View Mode Toggle -->
        <div style="display:flex; gap:4px; margin-bottom:8px; justify-content:center;">
          <button class="view-btn" id="listViewBtn" onclick="setViewMode('list')">üìã List</button>
          <button class="view-btn" id="gridViewBtn" onclick="setViewMode('grid')">‚äû Grid</button>
          <button class="view-btn" id="compactViewBtn" onclick="setViewMode('compact')">‚ä° Compact</button>
        </div>
        
        <!-- Recently Watched Section -->
        <div id="recentSection" style="display:none; margin-bottom:12px;">
          <div class="note" style="margin-bottom:4px;">Continue Watching</div>
          <div id="recentChannels" class="recent-list"></div>
        </div>
        
        <input id="q" type="search" placeholder="Search channels‚Ä¶">
        <ul id="list"></ul>
        <div id="gridContainer" class="grid-container" style="display:none;"></div>
      </aside>

      <section class="panel">
        <div class="topbar">
          <div id="title" class="name">Select a channel</div>
          <div style="display:flex; gap:8px;">
            <button class="btn" id="castBtn" style="display:none;">üì∫ Cast</button>
            <button class="btn" id="goLiveBtn" disabled>Go live</button>
          </div>
        </div>
        <video id="vid" controls playsinline webkit-playsinline preload="auto"></video>
        <div class="note" style="margin-top:8px;">Tip: tap a channel on the left. If playback stalls, try another entry (some may be offline).</div>
      </section>
    </div>

    <footer>
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <div>Goody IPTV ‚Ä¢ Unlock for unlimited access</div>
        <div id="socialProof" style="font-size:11px; color:var(--muted);">
          ‚≠ê Trusted by <span id="userCount">12,547</span> users worldwide
        </div>
      </div>
    </footer>
  </div>

  <!-- Paywall Modal -->
  <div id="paywallOverlay" class="paywall-overlay" style="display:none;">
    <div class="paywall-modal">
      <h2>üîí Trial Expired</h2>
      <p>Your 10-minute trial has ended.</p>
      <div class="pricing-info">
        <h3 style="color:#6aa7ff; margin:16px 0 8px;">Premium License</h3>
        <div style="font-size:24px; font-weight:bold; color:#6aa7ff;">$4.99</div>
        <div style="font-size:14px; color:#a7b1c7; margin-bottom:16px;">Valid for 6 months (180 days)</div>
        <div style="font-size:12px; color:#a7b1c7; margin-bottom:16px;">
          ‚úì Advanced 7-day EPG<br>
          ‚úì Watch history & resume<br>
          ‚úì Multiple themes<br>
          ‚úì Premium player features<br>
          ‚úì Works on all your devices
        </div>
      </div>
      <p>Enter your license key to continue:</p>
      <input id="unlockInput" class="unlock-input" type="text" placeholder="Enter 16-character license key" maxlength="16">
      <br>
      <div style="display:flex; gap:8px; justify-content:center; margin:16px 0;">
        <button id="unlockBtn" class="unlock-btn">Unlock Premium</button>
        <button id="purchaseBtn" class="purchase-btn">üí≥ Buy License</button>
      </div>
      <div class="trial-info">
        Get your license key:<br>
        Email: license@goodytv.com<br>
        Or visit: <a href="#" style="color:#6aa7ff;">goodytv.com/license</a>
        <div style="margin-top:8px; font-size:10px; color:var(--muted);">
          ‚≠ê Join 12,547+ satisfied users ‚Ä¢ 4.8/5 rating
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  <script src="config.js" onerror="console.warn('‚ö†Ô∏è config.js not found - using default settings')"></script>
  <script>
    const qs = s => document.querySelector(s);
    const listEl = qs('#list');
    const qEl = qs('#q');
    const titleEl = qs('#title');
    const video = qs('#vid');
    const loadBtn = qs('#loadBtn');
    const urlEl = qs('#playlistUrl');
    const goLiveBtn = qs('#goLiveBtn');
    const castBtn = qs('#castBtn');
    const paywallOverlay = qs('#paywallOverlay');
    const unlockInput = qs('#unlockInput');
    const unlockBtn = qs('#unlockBtn');
    const purchaseBtn = qs('#purchaseBtn');
    const trialTimer = qs('#trialTimer');
    const statusPill = qs('#statusPill');

    let CHANNELS = [];
    let CURRENT = -1;
    let hls;
    
    // Premium features
    let currentViewMode = 'list'; // 'list', 'grid', 'compact'
    let watchHistory = JSON.parse(localStorage.getItem('goodytv_watch_history') || '[]');
    let watchStartTime = null;
    
    // Chromecast
    let castSession = null;
    let castPlayer = null;

    // Paywall system
    const TRIAL_DURATION = 10 * 60 * 1000; // 10 minutes
    const UNLOCK_CODES = ['GOODY2024', 'PREMIUM123', 'UNLOCK456']; // Demo codes
    
    let trialStartTime = parseInt(localStorage.getItem('goodytv_trial_start') || '0');
    let isUnlocked = localStorage.getItem('goodytv_unlocked') === 'true';
    let trialTimeLeft = TRIAL_DURATION;

    function initTrial() {
      if (isUnlocked) {
        statusPill.innerHTML = '<span style="color:#4ade80;">‚úì Unlocked</span>';
        return;
      }
      
      if (!trialStartTime) {
        trialStartTime = Date.now();
        localStorage.setItem('goodytv_trial_start', trialStartTime.toString());
      }
      
      updateTrialTimer();
      setInterval(updateTrialTimer, 1000);
    }

    function updateTrialTimer() {
      if (isUnlocked) return;
      
      const elapsed = Date.now() - trialStartTime;
      trialTimeLeft = Math.max(0, TRIAL_DURATION - elapsed);
      
      if (trialTimeLeft <= 0) {
        showPaywall();
        return;
      }
      
      const minutes = Math.floor(trialTimeLeft / 60000);
      const seconds = Math.floor((trialTimeLeft % 60000) / 1000);
      trialTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function showPaywall() {
      paywallOverlay.style.display = 'flex';
      if (video && !video.paused) {
        video.pause();
      }
    }

    function unlock() {
      const code = unlockInput.value.trim().toUpperCase();
      if (UNLOCK_CODES.includes(code)) {
        localStorage.setItem('goodytv_unlocked', 'true');
        isUnlocked = true;
        paywallOverlay.style.display = 'none';
        statusPill.innerHTML = '<span style="color:#4ade80;">‚úì Unlocked</span>';
        alert('Successfully unlocked! Enjoy unlimited access.');
      } else {
        alert('Invalid unlock code. Please contact support.');
        unlockInput.value = '';
      }
    }

    unlockBtn.addEventListener('click', unlock);
    unlockInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') unlock();
    });
    
    // Payment integration
    purchaseBtn.addEventListener('click', () => {
      // Generate device ID for license binding
      let deviceId = localStorage.getItem('goodytv_device_id');
      if (!deviceId) {
        deviceId = 'goody_' + Math.random().toString(36).substr(2, 12) + '_' + Date.now();
        localStorage.setItem('goodytv_device_id', deviceId);
      }
      
      // Track purchase attempt
      if (typeof gtag !== 'undefined') {
        gtag('event', 'purchase_initiated', {
          value: 4.99,
          currency: 'USD',
          item_id: 'goody_iptv_license'
        });
      }
      
      // Get Stripe configuration
      const stripePublicKey = window.STRIPE_PUBLIC_KEY || 'pk_test_your_key_here';
      const stripePaymentLink = window.STRIPE_PAYMENT_LINK || 'https://buy.stripe.com/YOUR_LINK';
      
      if (stripePaymentLink.includes('YOUR_LINK')) {
        // Show setup instructions if not configured
        alert(`üöÄ Payment Integration Ready!\n\n` +
              `To activate payments:\n` +
              `1. Add your Stripe keys to the config\n` +
              `2. Replace STRIPE_PAYMENT_LINK with your actual link\n\n` +
              `Device ID: ${deviceId}\n` +
              `This will be used to generate your license key.`);
      } else {
        // Open actual payment link
        window.open(`${stripePaymentLink}?client_reference_id=${deviceId}`, '_blank');
      }
    });

    function parseM3U(text){
      const lines = text.split(/\r?\n/);
      const out = [];
      let meta = null;
      for (let line of lines){
        line = line.trim();
        if (!line) continue;
        if (line.startsWith('#EXTM3U')) continue;
        if (line.startsWith('#EXTINF:')){
          meta = {name:'', logo:'', group:'', tvgId:''};
          const comma = line.indexOf(',');
          const attrs = line.substring(8, comma>-1?comma:line.length);
          meta.name = comma>-1 ? line.substring(comma+1).trim() : '';
          const re = /([a-zA-Z0-9-]+)=\"(.*?)\"/g;
          let m; while((m = re.exec(attrs))){
            const k = m[1], v = m[2];
            if (k==='tvg-logo') meta.logo = v;
            if (k==='group-title') meta.group = v;
            if (k==='tvg-id') meta.tvgId = v;
          }
        } else if (meta && !line.startsWith('#')) {
          out.push({name: meta.name || line, url: line, logo: meta.logo, group: meta.group, tvgId: meta.tvgId});
          meta = null;
        }
      }
      return out;
    }

    function render(list){
      listEl.innerHTML = '';
      list.forEach((c, i) => {
        const li = document.createElement('li');
        li.className = (i===CURRENT)?'active':'';
        li.innerHTML = `
          <img class="logo" src="${c.logo||''}" onerror="this.style.visibility='hidden'">
          <div style="min-width:0">
            <div class="name">${c.name||'Untitled'}</div>
            <div class="sub">${c.group||new URL(c.url).hostname}</div>
          </div>`;
        li.onclick = () => playIndex(i);
        listEl.appendChild(li);
      });
    }

    function filter(){
      const q = qEl.value.trim().toLowerCase();
      const list = q ? CHANNELS.filter(c =>
        (c.name||'').toLowerCase().includes(q) ||
        (c.group||'').toLowerCase().includes(q)) : CHANNELS;
      render(list);
    }

    async function loadPlaylist(){
      const url = urlEl.value.trim();
      loadBtn.disabled = true; loadBtn.textContent = 'Loading‚Ä¶';
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt = await res.text();
        CHANNELS = parseM3U(txt);
        CURRENT = -1;
        qEl.value = '';
        filter();
        if (CHANNELS.length) playIndex(0);
      }catch(e){
        alert('Failed to load playlist: '+e.message);
      }finally{
        loadBtn.disabled = false; loadBtn.textContent = 'Load';
      }
    }

    function setupPlayer(src){
      if (!isUnlocked && trialTimeLeft <= 0) {
        showPaywall();
        return;
      }
      
      if (hls) { hls.destroy(); hls = null; }
      if (Hls.isSupported()) {
        hls = new Hls({lowLatencyMode:true, enableWorker:true, backBufferLength: 90});
        hls.loadSource(src);
        hls.attachMedia(video);
        hls.on(Hls.Events.ERROR, (_, data) => {
          console.warn('HLS error', data);
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = src;
      } else {
        video.src = src;
      }
    }

    function playIndex(i){
      const c = CHANNELS[i];
      CURRENT = i;
      titleEl.textContent = c.name;
      setupPlayer(c.url);
      watchStartTime = Date.now();
      addToWatchHistory(c);
      renderChannels();
      video.play().catch(()=>{});
    }

    // Go Live (seek to end) if possible
    goLiveBtn.onclick = () => { try{ video.currentTime = Math.max(0, video.seekable?.end(0) - 1); }catch{} };
    setInterval(() => {
      try{
        const liveEdge = video.seekable && video.seekable.length ? video.seekable.end(0) : NaN;
        goLiveBtn.disabled = !Number.isFinite(liveEdge) || Math.abs(liveEdge - video.currentTime) < 2;
      }catch{}
    }, 1000);

    qEl.addEventListener('input', filter);
    loadBtn.addEventListener('click', loadPlaylist);

    // Premium Features Implementation
    function setViewMode(mode) {
      currentViewMode = mode;
      localStorage.setItem('goodytv_view_mode', mode);
      
      // Update button states
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(mode + 'ViewBtn').classList.add('active');
      
      renderChannels();
    }
    
    function addToWatchHistory(channel) {
      const historyItem = {
        name: channel.name,
        group: channel.group || '',
        url: channel.url,
        lastWatched: Date.now(),
        duration: 0
      };
      
      // Remove existing entry and add new one at front
      watchHistory = [historyItem, ...watchHistory.filter(h => h.url !== channel.url)].slice(0, 20);
      localStorage.setItem('goodytv_watch_history', JSON.stringify(watchHistory));
      
      renderRecentChannels();
    }
    
    function renderRecentChannels() {
      const recentSection = document.getElementById('recentSection');
      const recentChannels = document.getElementById('recentChannels');
      
      if (watchHistory.length === 0) {
        recentSection.style.display = 'none';
        return;
      }
      
      recentSection.style.display = 'block';
      recentChannels.innerHTML = watchHistory.slice(0, 5).map(item => `
        <div class="recent-item" onclick="playFromHistory('${item.url}', '${item.name}')">
          <div class="recent-name">${item.name}</div>
          <div class="recent-time">${formatTimeAgo(item.lastWatched)}</div>
        </div>
      `).join('');
    }
    
    function playFromHistory(url, name) {
      const index = CHANNELS.findIndex(c => c.url === url);
      if (index !== -1) {
        playIndex(index);
      }
    }
    
    function formatTimeAgo(timestamp) {
      const diff = Date.now() - timestamp;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      return 'Just now';
    }
    
    function renderChannels() {
      const listEl = document.getElementById('list');
      const gridContainer = document.getElementById('gridContainer');
      
      if (currentViewMode === 'list') {
        listEl.style.display = 'block';
        gridContainer.style.display = 'none';
        filter(); // Use existing filter/render function
      } else {
        listEl.style.display = 'none';
        gridContainer.style.display = 'grid';
        gridContainer.className = 'grid-container ' + (currentViewMode === 'compact' ? 'compact-mode' : 'grid-mode');
        renderChannelGrid();
      }
    }
    
    function renderChannelGrid() {
      const gridContainer = document.getElementById('gridContainer');
      const query = qEl.value.toLowerCase();
      const filtered = query ? CHANNELS.filter(ch => 
        (ch.name||'').toLowerCase().includes(query) || (ch.group||'').toLowerCase().includes(query)
      ) : CHANNELS;
      
      gridContainer.innerHTML = filtered.map((ch, i) => {
        const originalIndex = CHANNELS.indexOf(ch);
        return `
          <div class="channel-card ${currentViewMode === 'compact' ? 'compact' : ''}" onclick="playIndex(${originalIndex})">
            <div class="channel-name">${ch.name || 'Untitled'}</div>
            ${currentViewMode !== 'compact' && ch.group ? `<div class="channel-group">${ch.group}</div>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // Initialize premium features
    const savedViewMode = localStorage.getItem('goodytv_view_mode') || 'list';
    currentViewMode = savedViewMode;
    document.getElementById(savedViewMode + 'ViewBtn').classList.add('active');
    
    // Social proof with realistic growth simulation
    function updateUserCount() {
      const baseCount = 12547;
      const daysSinceLaunch = Math.floor((Date.now() - new Date('2024-01-01').getTime()) / (1000 * 60 * 60 * 24));
      const growth = Math.floor(daysSinceLaunch * 2.3); // ~2-3 new users per day
      const randomVariation = Math.floor(Math.random() * 10);
      const totalUsers = baseCount + growth + randomVariation;
      
      document.getElementById('userCount').textContent = totalUsers.toLocaleString();
    }
    
    updateUserCount();
    setInterval(updateUserCount, 300000); // Update every 5 minutes
    
    // Initialize Chromecast
    function initializeCast() {
      if (typeof cast !== 'undefined') {
        const context = cast.framework.CastContext.getInstance();
        context.setOptions({
          receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
        
        context.addEventListener(
          cast.framework.CastContextEventType.CAST_STATE_CHANGED,
          (event) => {
            switch (event.castState) {
              case cast.framework.CastState.CONNECTED:
                castBtn.style.display = 'inline-block';
                castBtn.textContent = 'üì∫ Connected';
                castSession = context.getCurrentSession();
                break;
              case cast.framework.CastState.NOT_CONNECTED:
                castBtn.style.display = 'none';
                castSession = null;
                break;
            }
          }
        );
        
        // Show cast button if devices are available
        context.addEventListener(
          cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
          () => {
            if (context.getCastState() !== cast.framework.CastState.NO_DEVICES_AVAILABLE) {
              castBtn.style.display = 'inline-block';
              castBtn.textContent = 'üì∫ Cast';
            }
          }
        );
        
        castBtn.onclick = () => {
          if (castSession) {
            // Cast current stream
            const currentChannel = CHANNELS[CURRENT];
            if (currentChannel) {
              const mediaInfo = new chrome.cast.media.MediaInfo(currentChannel.url, 'application/x-mpegURL');
              mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
              mediaInfo.metadata.title = currentChannel.name;
              mediaInfo.metadata.subtitle = currentChannel.group;
              
              const request = new chrome.cast.media.LoadRequest(mediaInfo);
              castSession.loadMedia(request);
            }
          } else {
            context.requestSession();
          }
        };
      }
    }
    
    // Initialize cast when API loads
    window['__onGCastApiAvailable'] = function(isAvailable) {
      if (isAvailable) {
        initializeCast();
      }
    };
    
    // Check for completed payments periodically
    function checkForCompletedPayment() {
      // Only check if trial expired and not already unlocked
      if (!isTrialExpired() || isUnlocked()) return;

      // Get device ID
      const deviceId = localStorage.getItem('goodytv_device_id');
      if (!deviceId) return;

      console.log('üîç Checking for completed payment...');

      // Check payment status on both local and deployed endpoint
      const checkUrls = [
        'https://goody-iptv-o36jamyez-oduamehs-projects.vercel.app/api/check-payment',
        '/api/check-payment'
      ];

      checkUrls.forEach(baseUrl => {
        fetch(`${baseUrl}?deviceId=${deviceId}`)
          .then(response => response.json())
          .then(data => {
            if (data.paid && data.licenseKey) {
              console.log('üéâ Payment completed! Auto-unlocking...');
              unlock(data.licenseKey);
              showSuccessMessage(`‚úÖ License activated: ${data.licenseKey}`);
            }
          })
          .catch(error => console.log('Payment check failed:', error));
      });
    }

    function showSuccessMessage(message) {
      const successDiv = document.createElement('div');
      successDiv.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: #28a745; color: white; padding: 15px 20px;
        border-radius: 8px; font-size: 14px; max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      successDiv.textContent = message;
      document.body.appendChild(successDiv);

      setTimeout(() => {
        successDiv.remove();
      }, 5000);
    }

    // Initialize trial and auto-load playlist
    initTrial();
    loadPlaylist();

    // Check for completed payments every 10 seconds
    setInterval(checkForCompletedPayment, 10000);
    
    // Check immediately after 2 seconds
    setTimeout(checkForCompletedPayment, 2000);
  
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

</script>
</body>
</html>